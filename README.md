# balena-block-azure-relay

Cloud Relay accepts application data via MQTT and relays it to a Azures's IoT Hub facility. You only need to provide the data, and Cloud Relay takes care of messaging with the cloud provider.

## Getting Started

You first must set up the Azures's IoT service. See the _Cloud Provisioning_ section below.

### Device

### Cloud Provisioning

Cloud Relay triggers secure provisioning of a balena device to the provider's registry before publishing data. This provisioning generates public key credentials as environment variables, which are stored on balenaCloud and passed on to the device. Cloud Relay then uses the credentials to communicate with the provider's IoT Core.

We have developed projects that automate this provisioning, including use of the provider's "cloud function" capability to trigger the provisioning code via HTTP request. See the linked projects in the table below and the environment variables in the _Configuration_ section below.

| Provider / Cloud Function | GitHub project                                                                   |
| ------------------------- | -------------------------------------------------------------------------------- |
| Azure Functions           | [azure-iot-provision](https://github.com/balena-io-examples/azure-iot-provision) |

## Configuration

Environment variables, probably common to all devices so may be defined as balena **Fleet** variables.

### Azure

| Name           | Value                                                               | Notes                                                                          |
| -------------- | ------------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| PROVISION_URL  | like<br>`https://<region>-<projectID>.cloudfunctions.net/provision` | URL to trigger the provisioning cloud function.                                |
| AZURE_HUB_HOST | like<br>`<iot-hub-name>.azure-devices.net`                          | Host name to receive data. See _Overview_ for the IoT Hub in the Azure portal. |

AZURE_CERT and AZURE_PRIVATE_KEY variables for each device are generated by the [provisioning tool](https://github.com/balena-io-examples/azure-iot-provision#device-environment-variables).
